name: Docker publish
on:
  push:
    branches:
      - main
      - "[0-9][0-9][0-9][0-9]/[0-9][0-9]/1"
      - "[0-9][0-9][0-9][0-9]/[0-9][0-9]/2"
jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: compute_tag
        name: Compute sanitized branch tag and short SHA
        shell: bash
        run: |
          if [ -n "$GITHUB_HEAD_REF" ]; then
            BRANCH="$GITHUB_HEAD_REF"
          else
            BRANCH="${GITHUB_REF#refs/heads/}"
          fi
          BRANCH_TAG=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/\//-/g' | sed 's/[^a-z0-9._-]/-/g' | sed 's/^-*//; s/-*$//')
          SHORT_SHA=${GITHUB_SHA:0:7}
          REPO="$GITHUB_REPOSITORY"
          if [ "$BRANCH_TAG" = "main" ] || [ -z "$BRANCH_TAG" ]; then
            TAGS="ghcr.io/${REPO}:latest,ghcr.io/${REPO}:${SHORT_SHA}"
          else
            TAGS="ghcr.io/${REPO}:latest,ghcr.io/${REPO}:${BRANCH_TAG},ghcr.io/${REPO}:${SHORT_SHA}"
          fi
          echo "BRANCH_TAG=$BRANCH_TAG" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "TAGS=$TAGS" >> $GITHUB_OUTPUT

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.created=${{ github.run_id }}
          tags: ${{ steps.compute_tag.outputs.TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
